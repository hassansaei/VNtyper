# Mutation Counter Pipeline

This repository contains two scripts that together form a bioinformatics pipeline for detecting MUC1 variants:

1. **`count_variants.sh`** – A Bash script that uses `samtools` and `awk` to count the occurrences of specific target variant sequences (or their reverse complements) in a BAM file.
2. **`do_it.R`** – An R script that processes the count file generated by `count_variants.sh` and performs pairwise Fisher's exact tests to identify statistically significant differences between samples.

> **Note:** The original article focused on analyzing pre‐generated count data rather than describing how the raw sequencing reads are converted into counts. Because the upstream processing details were not provided, the intermediate counting script was reimplemented as `count_variants.sh`.

---

## count_variants.sh

### Overview

`count_variants.sh` is a Bash script that:
- Uses `samtools` to stream SAM records from an input BAM file.
- Derives the sample name from the BAM file’s basename (by stripping the `.bam` extension).
- Uses an embedded `awk` program to count occurrences of specific target variant sequences (or their reverse complements) in the read sequences.
- Outputs a tab-delimited (or CSV) table containing counts for each variant.
- If an output file is provided and a row for the sample already exists, the script updates that row; otherwise, it appends a new row.

### Target Variant Sequences

The script searches for the following target sequences:

- **MUT_27dupC**: `GGGCTCCACCGCCCCCCCCAGCCCACGGTGTC`
- **MUT_27insCCCC**: `GGGCTCCACCGCCCCCCCCCCCAGCCCACGGTGTC`
- **MUT_26_27insG**: `GGGCTCCACCGCCCCCCGCAGCCCACGGTGTC`
- **MUT_28dupA**: `GGGCTCCACCGCCCCCCCAAGCCCACGGTGT`
- **MUT_23delinsAT**: `GGCTCCACCGCCATCCCCAGCCCACGGTGTC`
- **WT**: `GGGCTCCACCGCCCCCCCAGCCCACGGTGTC`
- **All**: A regex pattern (`GGGCTCCACCG.*CCCCCCCAGCCCACGGTGTC`) to capture additional variations.

### Dependencies

- **Bash**
- **samtools**:  
  _Installation (Ubuntu):_
  ```bash
  sudo apt-get install samtools
  ```
  _Or on macOS (via Homebrew):_
  ```bash
  brew install samtools
  ```
- **awk**: (GNU awk is typically available by default)
- Standard Unix utilities (`grep`, `sed`)

### Usage

```bash
./count_variants.sh -i input.bam [-o output.csv]
```

#### Options

- `-i input.bam`  
  **Required.** Specifies the input BAM file.

- `-o output.csv`  
  **Optional.** Specifies the output CSV file. If this file exists:
  - The script checks if a row for the sample (derived from the BAM file's basename) already exists.
  - If it exists, the row is overwritten.
  - If not, the new row is appended.
  
If the output file is not provided, the result is printed to stdout.

#### Examples

1. **Print output to stdout:**

   ```bash
   ./count_variants.sh -i sample1.bam
   ```

2. **Write or update output in a CSV file:**

   ```bash
   ./count_variants.sh -i sample1.bam -o counts.csv
   ```

### Logic and Workflow

1. **Input Parsing:**  
   Reads the input BAM file specified with the `-i` option and derives the sample name from its basename.

2. **Streaming SAM Records:**  
   Uses `samtools view` to stream the SAM records from the BAM file.

3. **AWK Processing:**  
   The embedded `awk` program:
   - Defines a function `revcomp()` to compute the reverse complement of a DNA sequence.
   - Specifies the target variant sequences (and a regex for "All") and initializes count variables.
   - For each SAM record (ignoring headers starting with `@`), extracts the read sequence (field 10), computes its reverse complement, and checks for matches to each target sequence.
   - Increments the corresponding counts.

4. **Output Generation:**  
   Outputs a header row (if the output file is new) followed by the sample row. If an output file exists, the script checks for an existing row for the sample and updates it; otherwise, it appends a new row.

---

## do_it.R

### Overview

`do_it.R` is an R script that processes the count file produced by `count_variants.sh` and performs pairwise Fisher's exact tests to identify statistically significant differences between samples. The script was refactored from the original supplementary material.

### Input File Format

The count file (e.g., `test.tsv`) must be a tab-delimited file with a header row. Each row represents a sample and includes:
- **Sample Name**: Typically the first column.
- **Control and Mutation Counts**: Columns such as `All`, `MUT_27dupC`, `MUT_27insCCCC`, etc.

### Dependencies

- **R**: Version ≥ 3.6.1 is recommended.
- Uses built-in functions (`read.csv`, `fisher.test`, etc.) so no additional packages are required.

### Usage

The script expects at least three command-line arguments:

1. **Count file**: The path to the count file (e.g., `test.tsv`)
2. **Control column**: The name of the control column (e.g., `All`)
3. **Mutation column(s)**: One or more mutation column names to test against the control column.

#### Example

```bash
Rscript do_it.R test.tsv All MUT_27dupC
```

In this example:
- `test.tsv` is the input count file.
- `All` is used as the control column.
- `MUT_27dupC` is the mutation column to compare against the control.

### Script Logic

1. **File Reading & Argument Checking:**  
   The script reads the input count file (assumed to be tab-delimited) and verifies that the control column and specified mutation columns exist. If any are missing, it reports an error.

2. **Filtering Samples:**  
   Each sample must have at least one count (in either the control or mutation column) greater than or equal to a predefined threshold (`MIN_COUNTS`, set to 100). Samples that do not meet this requirement are excluded from further analysis.

3. **Pairwise Fisher's Exact Tests:**  
   For each mutation column provided, the script:
   - Constructs a 2×2 contingency table for each pair of samples:
     - One cell is the difference between the control and mutation counts.
     - The other cell is the mutation count.
   - Performs Fisher’s exact test (with the alternative hypothesis `"greater"`) on these tables.
   - Stores and prints the p-values in a matrix format.

4. **Output Summary:**  
   The script prints a matrix of p-values for pairwise comparisons and summarizes which samples are significant (p ≤ 0.001) based on various thresholds.

---

## Intermediate Counting Script Note

The original article did not provide details on how raw sequencing reads were processed into count data—the focus was solely on analyzing pre-generated counts corresponding to specific MUC1 VNTR variations (and a generic "All" category). As a result, the upstream processing steps (e.g., filtering, alignment, and counting) were not described. To fill this gap, the intermediate counting script (`count_variants.sh`) was reimplemented using Bash and AWK to generate the count file used by the R script.

---

## Citations

- **Original Article:**  
  *Description of a New Simple and Cost-Effective Molecular Testing That Could Simplify MUC1 Variant Detection*  
  [PubMed](https://pubmed.ncbi.nlm.nih.gov/38707821/)

- **Supplementary Material Reference:**  
  Kirby et al. (2013) – Supplementary material available at:  
  [https://ars.els-cdn.com/content/image/1-s2.0-S2468024924000706-mmc1.pdf](https://ars.els-cdn.com/content/image/1-s2.0-S2468024924000706-mmc1.pdf)

---

## License

This project is released under the MIT License.

---
