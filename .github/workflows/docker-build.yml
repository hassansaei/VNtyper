# This workflow is run as part of CI to test that they run through.
#
# The images are pushed to `ghcr.io` and 'docker hub' for each PR and branch.  The ones for
# the releases are pushed in `release-please.yml`.
name: Docker Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  GHCR_REGISTRY: ghcr.io
  DOCKERHUB_REGISTRY: docker.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # Required for ghcr.io

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Docker Buildx (required for caching)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Log in to GitHub Container Registry (ghcr.io)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Log in to Docker Hub
      #- name: Log in to Docker Hub
        #uses: docker/login-action@v3
        #with:
          #registry: ${{ env.DOCKERHUB_REGISTRY }}
          #username: ${{ secrets.DOCKER_USERNAME }}  # Added to GitHub secrets
          #password: ${{ secrets.DOCKER_PASSWORD }}  # Added to GitHub secrets

      # Extract metadata (tags, labels) for Docker
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.GHCR_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=schedule
            type=ref,event=branch
            type=ref,event=tag
            type=ref,event=pr
            type=sha

      # Build and push Docker image to both registries
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          push: true
          # Enable GitHub Actions caching for 60-80% faster builds
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Docker Quick Tests - Run on all PRs for fast feedback
  test-docker-quick:
    name: Docker Tests (Quick)
    needs: build-and-push-image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      # Cache test data to avoid re-downloading 290MB archive on every run
      - name: Cache test data
        id: cache-test-data
        uses: actions/cache@v4
        with:
          path: tests/data
          key: test-data-${{ hashFiles('tests/test_data_config.json') }}
          restore-keys: |
            test-data-

      # Download test data if not cached
      - name: Download test data
        if: steps.cache-test-data.outputs.cache-hit != 'true'
        run: |
          python3 -c "
          import json, logging
          from tests.test_data_utils import ensure_test_data_downloaded

          logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')

          with open('tests/test_data_config.json') as f:
              config = json.load(f)

          print('Downloading test data (290MB archive from Zenodo)...')
          ensure_test_data_downloaded(config)
          print('✓ Test data download complete')
          "
        timeout-minutes: 20

      - name: Run Docker quick tests
        run: make test-docker-quick
        timeout-minutes: 20

      - name: Display test summary
        if: always()
        run: |
          echo "✓ Docker quick tests completed"

  # Docker Full Test Suite - Run only on main branch
  test-docker-full:
    name: Docker Tests (Full Suite)
    needs: build-and-push-image
    runs-on: ubuntu-latest
    # Only run full suite on main branch or manual trigger
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      # Cache test data to avoid re-downloading 290MB archive on every run
      - name: Cache test data
        id: cache-test-data-full
        uses: actions/cache@v4
        with:
          path: tests/data
          key: test-data-${{ hashFiles('tests/test_data_config.json') }}
          restore-keys: |
            test-data-

      # Download test data if not cached
      - name: Download test data
        if: steps.cache-test-data-full.outputs.cache-hit != 'true'
        run: |
          python3 -c "
          import json, logging
          from tests.test_data_utils import ensure_test_data_downloaded

          logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')

          with open('tests/test_data_config.json') as f:
              config = json.load(f)

          print('Downloading test data (290MB archive from Zenodo)...')
          ensure_test_data_downloaded(config)
          print('✓ Test data download complete')
          "
        timeout-minutes: 20

      - name: Run full Docker test suite
        run: make test-docker
        timeout-minutes: 60

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-test-results-${{ github.run_id }}
          path: |
            pytest-results/
            htmlcov/
          retention-days: 30
